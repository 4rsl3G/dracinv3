<!doctype html>
<html lang="<%= lang || 'en' %>">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= (meta && meta.title) ? meta.title : "CineStream Pro" %></title>
  <meta name="description" content="<%= (meta && meta.description) ? meta.description : "" %>"/>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          colors: {
            cs: {
              bg: "#141414",
              surface: "#181818",
              text: "#E5E5E5",
              accent: "#E50914"
            }
          },
          boxShadow: {
            glow: "0 12px 50px rgba(0,0,0,.55)"
          }
        }
      }
    }
  </script>

  <style>
    :root { color-scheme: dark; }
    body { background: #141414; color: #E5E5E5; }

    /* Skeleton shimmer */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.05), rgba(255,255,255,.10), rgba(255,255,255,.05));
      background-size: 200% 100%;
      animation: shimmer 1.25s infinite;
    }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* Navbar transition */
    .nav-solid { background: rgba(0,0,0,.85); backdrop-filter: blur(10px); }

    /* Hide scrollbars in drawers */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>

<body class="font-sans antialiased">
  <!-- Top Nav -->
  <header id="topNav" class="fixed top-0 left-0 right-0 z-50 transition-colors duration-300">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <a href="/?lang=<%= encodeURIComponent(lang || 'en') %>" class="flex items-center gap-3">
          <div class="w-9 h-9 rounded bg-cs-accent grid place-items-center shadow-glow">
            <span class="font-black text-black">C</span>
          </div>
          <div class="leading-tight">
            <div class="font-extrabold tracking-tight">CineStream <span class="text-cs-accent">Pro</span></div>
            <div class="text-xs text-white/60 -mt-0.5">Premium streaming UI</div>
          </div>
        </a>

        <div class="flex items-center gap-3">
          <!-- Search -->
          <div class="relative hidden sm:block">
            <input id="navSearch"
              class="w-[360px] bg-white/5 focus:bg-white/10 border border-white/10 focus:border-white/20 rounded-lg px-3 py-2 text-sm outline-none"
              placeholder="Search movies, shows..."
              autocomplete="off"
            />
            <div id="searchPanel"
              class="hidden absolute mt-2 w-[520px] right-0 bg-cs-surface/95 border border-white/10 rounded-xl shadow-glow overflow-hidden">
              <div class="p-3 border-b border-white/10 flex items-center justify-between">
                <div class="text-sm font-semibold">Search results</div>
                <button id="searchClose" class="text-xs text-white/60 hover:text-white">Esc</button>
              </div>
              <div id="searchResults" class="max-h-[60vh] overflow-auto no-scrollbar p-2"></div>
            </div>
          </div>

          <!-- Language -->
          <form method="get" action="/" class="hidden md:flex items-center gap-2">
            <select name="lang" class="bg-white/5 border border-white/10 rounded-lg px-2 py-2 text-sm">
              <% if (typeof languages !== 'undefined' && Array.isArray(languages) && languages.length) { %>
                <% languages.forEach(function(l){ %>
                  <option value="<%= l %>" <%= (l === (lang || 'en')) ? "selected" : "" %>><%= l %></option>
                <% }) %>
              <% } else { %>
                <option value="<%= lang || 'en' %>" selected><%= lang || 'en' %></option>
              <% } %>
            </select>
            <button class="bg-white/10 hover:bg-white/15 border border-white/10 rounded-lg px-3 py-2 text-sm">
              Apply
            </button>
          </form>
        </div>
      </div>
    </div>
  </header>

  <main class="pt-16">
    <%- body %>
  </main>

  <script>
    // Nav solid on scroll
    (function () {
      const nav = document.getElementById("topNav");
      const onScroll = () => {
        if (window.scrollY > 10) nav.classList.add("nav-solid");
        else nav.classList.remove("nav-solid");
      };
      onScroll();
      window.addEventListener("scroll", onScroll, { passive: true });
    })();

    // Search overlay (AJAX)
    (function () {
      const input = document.getElementById("navSearch");
      const panel = document.getElementById("searchPanel");
      const resultsEl = document.getElementById("searchResults");
      const closeBtn = document.getElementById("searchClose");

      if (!input || !panel || !resultsEl) return;

      let timer = null;
      let lastQ = "";
      const lang = "<%= (lang || 'en').replace(/"/g, '') %>";

      function openPanel() { panel.classList.remove("hidden"); }
      function closePanel() { panel.classList.add("hidden"); }
      function escClose(e) { if (e.key === "Escape") closePanel(); }

      closeBtn && closeBtn.addEventListener("click", closePanel);
      document.addEventListener("keydown", escClose);

      function card(item) {
        const cover = item.cover || "";
        const name = item.name || "Untitled";
        const code = item.code || "";
        const href = "/watch/" + encodeURIComponent(code) + "?lang=" + encodeURIComponent(lang) + "&ep=1";
        return `
          <a href="${href}" class="group flex gap-3 p-2 rounded-lg hover:bg-white/5 transition">
            <div class="w-16 h-10 rounded-md overflow-hidden bg-white/5 border border-white/10 flex-none">
              ${cover ? `<img src="${cover}" class="w-full h-full object-cover group-hover:scale-[1.03] transition" />` : ""}
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${name}</div>
              <div class="text-xs text-white/50">Code: ${code}</div>
            </div>
          </a>
        `;
      }

      async function runSearch(q) {
        resultsEl.innerHTML = `
          <div class="p-2 space-y-2">
            <div class="h-12 rounded-lg skeleton"></div>
            <div class="h-12 rounded-lg skeleton"></div>
            <div class="h-12 rounded-lg skeleton"></div>
          </div>
        `;
        openPanel();

        const res = await fetch("/api/search?q=" + encodeURIComponent(q) + "&lang=" + encodeURIComponent(lang));
        const json = await res.json();
        const results = (json && json.results) || [];

        if (!results.length) {
          resultsEl.innerHTML = `<div class="p-4 text-sm text-white/60">No results for <span class="text-white">${q}</span>.</div>`;
          return;
        }

        resultsEl.innerHTML = `<div class="p-1">${results.slice(0, 30).map(card).join("")}</div>`;
      }

      input.addEventListener("focus", () => {
        if (input.value.trim().length >= 2) openPanel();
      });

      input.addEventListener("input", () => {
        const q = input.value.trim();
        if (q.length < 2) { closePanel(); return; }
        if (q === lastQ) return;

        lastQ = q;
        clearTimeout(timer);
        timer = setTimeout(() => runSearch(q).catch(() => {
          resultsEl.innerHTML = `<div class="p-4 text-sm text-white/60">Search failed. Try again.</div>`;
          openPanel();
        }), 220);
      });

      document.addEventListener("click", (e) => {
        if (!panel.contains(e.target) && e.target !== input) closePanel();
      });
    })();
  </script>
</body>
</html>
